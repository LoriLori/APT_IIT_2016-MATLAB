%% Run meal detection and meal bolusing algorithms. Kamuran Turksoy
function [meal_states,meal_covariance,bolus_insulin,...
    meal_bolus_amount,meal_detection,meal_detection_time,...
    correction_bolus_amount,correction_detection,correction_detection_time,correction_limit,...
    meal_g_basal,meal_gpc_gs_slope_degree,meal_gpc_mu]=m20150711_run_meal_detection_bolus_algorithm(meal_states,bolus_insulin,...
    meal_bolus_amount,meal_detection,meal_detection_time,...
    correction_bolus_amount,correction_detection,correction_detection_time,correction_limit,...
    gs,kj,meal_g_basal,meal_gpc_gs_slope_degree,meal_gpc_mu,...
    sleep,phys_act,IOB_total,body_weight)

body_weight=136.0   

 bolus_insulin=[0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0]

 correction_bolus_amount=[0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0]

correction_detection=[ 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0]

correction_detection_time=[0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0]

correction_limit=[ 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0]

 gs=[285.0 285.0 285.0 285.0 285.0 285.0 285.0 285.0 285.0 285.0 285.0 285.0 285.0 285.0 285.0 285.0 285.0 285.0 285.0 285.0 200.0 198.0 185.0 180.0 165.0 164.0 158.0 150.0 144.0 140.0 132.0 125.0 122.0 119.0 116.0 114.0]'

 meal_bolus_amount=[0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0]

meal_detection=[ 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0]

meal_detection_time=[ 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0]

 meal_g_basal=[285.0
 285.0
 285.0
 285.0
 285.0
 285.0
 285.0
 285.0
 285.0
 285.0
 285.0
 285.0
 285.0
 285.0
 285.0
 285.0
 285.0
 285.0
 285.0
 285.0
 285.0
 285.0
 285.0
 285.0
 285.0
 285.0
 285.0
 270.8333333333333
 256.3333333333333
 239.66666666666666
 222.16666666666666
 202.16666666666666
 182.0
 175.0
 167.0
 160.16666666666666]

 meal_gpc_gs_slope_degree=[45.0
 45.0
 45.0
 45.0
 45.0
 45.0
 45.0
 45.0
 45.0
 45.0
 45.0
 45.0
 45.0
 45.0
 45.0
 45.0
 45.0
 45.0
 45.0
 45.0
 45.0
 -73.61048598642792
 -79.07348191095306
 -80.11737248246263
 -77.47121999177084
 -60.39557084927936
 -60.39557084927936
 -54.46234168180049
 -53.267192381943104
 -48.23971754489039
 -51.11552184335786
 -51.11552184335786
 -51.11552184335786
 -49.72015470918291
 -46.123319206115745
 -37.23484729541707]

meal_gpc_mu=[0.5
 0.5
 0.5
 0.5
 0.5
 0.5
 0.5
 0.5
 0.5
 0.5
 0.5
 0.5
 0.5
 0.5
 0.5
 0.5
 0.5
 0.5
 0.5
 0.5
 0.5
 0.5
 0.5
 0.5
 0.5
 0.5
 0.5
 0.5
 0.5
 0.5
 0.5
 0.5
 0.5
 0.5
 0.5
 0.5]

meal_states=[0.1 0.1 0.1 0.1 0.1 0.1 0.1 0.1 0.1 0.1 0.1 0.1 0.1 0.1 0.1 0.1 0.1 0.1 0.1 0.1 0.1 0.12751744791666667 0.09080078231738582 0.08554047475675831 0.08171027154941966 0.10095938141266797 0.08940417406271091 0.10187758778207766 0.09641760268192824 0.08954810628401177 0.09618243024536871 0.08478772449452195 0.09307146265381715 0.0990483598552706 0.08843771001190963 0.12312572554658201
 285.0 285.0 285.0 285.0 285.0 285.0 285.0 285.0 285.0 285.0 285.0 285.0 285.0 285.0 285.0 285.0 285.0 285.0 285.0 285.0 285.0 200.0 198.0 185.0 180.0 165.0 164.0 158.0 150.0 144.0 140.0 132.0 125.0 122.0 119.0 116.0
 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -2.7107017401581625E-10 0.01060582918942487 0.042465319052062744 0.0753188220951221 0.17245484761636315 0.285881403381614 0.3686499005347539 0.45954986633177686 0.4697660466369335 0.4833557296990929 0.5782912293214321 0.7138205435766805 0.7603330623270381 0.819203985369317 0.8208149949464254
 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -8.461950039881553E-10 -0.0016764870843861048 0.03431777744649016 0.031246256064139943 0.09545171954370797 0.23548301444387393 0.33127771171371373 0.4383167880754925 0.45662186053204895 0.4559617494860679 0.5156052178706811 0.6151299775529143 0.6646098633491734 0.7958401800146427 0.84939637404906
 0.068 0.068 0.068 0.068 0.068 0.068 0.068 0.068 0.068 0.068 0.068 0.068 0.068 0.068 0.068 0.068 0.068 0.068 0.068 0.068 0.068 0.0914130859375 0.10224215017613432 0.09363168452362647 0.09354381215422945 0.07727839601146085 0.08899894436185028 0.08820975213245741 0.0929145817420685 0.09373768478673135 0.08490450207629423 0.08521212536842843 0.08586717713368794 0.08525074038115449 0.08812078169642194 0.08171300222149377
 0.037 0.037 0.037 0.037 0.037 0.037 0.037 0.037 0.037 0.037 0.037 0.037 0.037 0.037 0.037 0.037 0.037 0.037 0.037 0.037 0.037 0.03309781901041667 0.03757362752110308 0.03976222664997045 0.038331448980276094 0.04828908592030952 0.0394476619499289 0.04370354416158782 0.04369635613981856 0.04363799578155277 0.04881655730323394 0.04622348490229023 0.04792448113225024 0.04140830966484132 0.047604636530159256 0.04736105432134401
 1.3 1.3 1.3 1.3 1.3 1.3 1.3 1.3 1.3 1.3 1.3 1.3 1.3 1.3 1.3 1.3 1.3 1.3 1.3 1.3 1.3 1.6121744791666666 1.4073546144018765 1.3855939771645573 1.3507894499539823 1.3891842931854592 1.3406204518196811 1.3962299678366306 1.3601829457490406 1.3533700075269013 1.3599519718992121 1.3596867659876624 1.3679094247031451 1.2954784173001457 1.3015419107506532 1.2040158097480038
 20.0 20.0 20.0 20.0 20.0 20.0 20.0 20.0 20.0 20.0 20.0 20.0 20.0 20.0 20.0 20.0 20.0 20.0 20.0 20.0 20.0 20.0 19.935512947695237 19.929187059484768 19.894304190741995 19.853599243893353 19.79156280415578 19.81871416810533 19.800212165371953 19.79825453177498 19.845143971313746 19.884420526894363 19.873172052395795 19.971085823542907 19.900744965978532 20.112623848972955]
 
phys_act=[0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0]'
sleep=[1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0]'

IOB_total=[0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.018574650603170356
 0.4022280756374631
 1.0123943366826982
 0.9992668035981563
 0.9817314716650662
 0.9735945194568909
 0.5164679195679579
 0.4720542990700919
 0.4185283807393034
 0.360694042503653
 0.30264880767698377
 0.2703823135075857
 0.22063420220221455
 0.1778633619617186
 0.14260276386114737]

kj=36;
meal_covariance(:,:,37)=zeros(8,8);
meal_covariance(:,:,36)=[0.01041731458009985			0.0			-0.01088252495317938			-0.0064466154715434295			-7.267051748538752E-4			3.2190184458844257E-4			-0.010863724388590304			0.002591764755910864
			0.0			9.999999974752427E-7			0.0			0.0			0.0			0.0			0.0			0.0
			-0.01088252495317938			0.0			0.219851342241546			0.1847128706643592			-0.0073299114367380925			-0.002335120507141969			0.026181132820339077			0.060181219482289244
			-0.0064466154715434295			0.0			0.1847128706643592			0.1677740787923852			-0.0073496057386593615			-0.001579772714097053			0.018972187365880876			0.06969137343932677
			-7.267051748538752E-4			0.0			-0.0073299114367380925			-0.0073496057386593615			0.011034241587129871			7.137400482623607E-5			-0.001548035517494333			-0.007680201142589076
			3.2190184458844257E-4			0.0			-0.002335120507141969			-0.001579772714097053			7.137400482623607E-5			0.10033701641829162			-6.694417598946664E-4			-0.0050283864776997185
			-0.010863724388590304			0.0			0.02618113282033908			0.018972187365880876			-0.001548035517494333			-6.694417598946664E-4			0.09427397791923271			0.03795792208333869
			0.0025917647559108646			0.0			0.060181219482289244			0.06969137343932677			-0.007680201142589076			-0.0050283864776997185			0.03795792208333869			1.2986638875124152]

if kj>12 % update basal glucose value for meal detection algorithm
    meal_g_basal=cat(1,meal_g_basal,mean(gs(kj-11:kj-6)));
else
    meal_g_basal=cat(1,meal_g_basal,100);
end

if kj>5 % update glucose slope
    size(gs)
    meal_gpc_line=polyfit([0 5 10 15 20]',gs(kj-4:kj,1),1);
    meal_gpc_gs_slope_degree=cat(1,meal_gpc_gs_slope_degree,radtodeg(atan(meal_gpc_line(1))));
else
    meal_gpc_gs_slope_degree=cat(1,meal_gpc_gs_slope_degree,45);
end


if sleep(kj,1)==1 % update mu (mu is defined in our TBME paper)
    meal_gpc_mu=cat(1,meal_gpc_mu,1-1*max(0.5,meal_gpc_gs_slope_degree(kj,1)/90));
elseif phys_act(kj,1)==1
    meal_gpc_mu=cat(1,meal_gpc_mu,1-0.025*max(0.5,meal_gpc_gs_slope_degree(kj,1)/90));
else
    meal_gpc_mu=cat(1,meal_gpc_mu,1-max(0.5,meal_gpc_gs_slope_degree(kj,1)/90));
end
Q_p_meal=1e-6*diag([1 1 1e+3 1e+3 1e+4 1e+5 1e+4 1e+5]); % Process noise 
R_meal=100; % Measurement noise
[meal_states(:,kj),meal_covariance(:,:,kj)]=m20141215_ukf_meal(gs(kj,1),meal_states(:,kj-1),meal_covariance(:,:,kj-1),R_meal,Q_p_meal,meal_g_basal(kj,1));
[meal_bolus_amount(kj,1),correction_detection(kj,1),meal_detection(kj,1),meal_detection_time(kj,1),correction_detection_time(kj,1),correction_limit(kj,1),correction_bolus_amount(kj,1)]=m20150308_detection_of_meal(meal_states(:,kj),gs(kj,1),meal_detection(kj-1,1),meal_detection_time(kj-1,1),correction_detection_time(kj-1,1),correction_limit(kj-1,1),correction_bolus_amount(kj-1,1),kj,body_weight,sleep(kj,1),phys_act(kj,1),meal_gpc_mu(kj,1));


bolus_insulin=cat(1,bolus_insulin,round(max(0,meal_bolus_amount(kj,1)*meal_detection(kj,1)+correction_detection(kj,1)*correction_bolus_amount(kj,1)-IOB_total(kj,1))/0.05)*0.05);% Update bolus insulin