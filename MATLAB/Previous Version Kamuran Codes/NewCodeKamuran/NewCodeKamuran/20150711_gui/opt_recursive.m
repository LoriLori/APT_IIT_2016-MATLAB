function [Q Y_model P lamda err]=opt_recursive(Y,phi,Q_old,P_old,lamda_old,upperlim,lowerlim)

Y=170.0


P_old=[1499.3568037119417 -749.6783651233568 -749.6783651233568 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -0.4092657234213736 0.0 0.0 0.0 -0.13642190780712454 0.0 0.0 0.0 -63.95855561105321
 -749.6783651233568 1500.721008962652 -751.0425980287889 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.20463493581482134 0.0 0.0 0.0 0.06821164527160711 0.0 0.0 0.0 31.97960193896129
 -749.6783651233568 -751.0425980287889 1500.721008962652 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.20463493581482134 0.0 0.0 0.0 0.06821164527160711 0.0 0.0 0.0 31.97960193896129
 0.0 0.0 0.0 2251.7636069914406 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0
 0.0 0.0 0.0 0.0 2251.7636069914406 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0
 0.0 0.0 0.0 0.0 0.0 2251.7636069914406 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0
 0.0 0.0 0.0 0.0 0.0 0.0 2251.7636069914406 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0
 0.0 0.0 0.0 0.0 0.0 0.0 0.0 2251.7636069914406 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0
 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 2251.7636069914406 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0
 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 2251.7636069914406 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0
 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 2251.7636069914406 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0
 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 2251.7636069914406 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0
 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 2251.7636069914406 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0
 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 2251.7636069914406 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0
 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 2251.7636069914406 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0
 -0.40926572342136747 0.2046349358148206 0.20463493581482334 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 2251.671521892555 0.0 0.0 0.0 -0.030695032961809716 0.0 0.0 0.0 -14.39072363250216
 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 2251.7636069914406 0.0 0.0 0.0 0.0 0.0 0.0 0.0
 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 2251.7636069914406 0.0 0.0 0.0 0.0 0.0 0.0
 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 2251.7636069914406 0.0 0.0 0.0 0.0 0.0
 -0.1364219078071234 0.06821164527160686 0.06821164527160686 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -0.030695032961809716 0.0 0.0 0.0 2251.753375313787 0.0 0.0 0.0 -4.796907877500722
 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 2251.7636069914406 0.0 0.0 0.0
 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 2251.7636069914406 0.0 0.0
 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 2251.7636069914406 0.0
 -63.95855561105207 31.979601938961398 31.979601938961046 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -14.39072363250216 0.0 0.0 0.0 -4.796907877500722 0.0 0.0 0.0 2.8337673795181217
]

phi=[ -180.0
 -183.0
 -185.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.3
 0.3
 0.0
 0.0
 0.1
 0.1
 0.0
 0.0
 23.1052516171182];

Q_old=[0.5192666900258629
 -0.9091528121388389
 -0.35727451921357667
 -0.014714236141579889
 -0.014714236073140555
 -0.014714236135136623
 -0.014714236077420825
 -0.014714236076754886
 -0.01471423613127144
 -0.014714236074413859
 -0.014714236004134622
 -0.014714235935316441
 -0.014714235879247884
 -0.054902953649883936
 -0.014714235804700677
 -0.013880636992444104
 9.454242944073596E-17
 9.454242944073591E-17
 -0.15184937772160834
 0.3353895508901955
 2.2551405187698782E-17
 0.014460004814924468
 3.556183125752462E-17
 0.6212141988280625]

lamda_old=0.230719738396;

upperlim=[1.0      1.0      1.0      0.0      0.0      0.0      0.0      0.0      0.0      0.0      0.0      0.0      0.0      0.0      0.0      0.0      0.0      0.0      0.0      1.0      1.0      1.0      1.0      1.0]

lowerlim=[-1.0      -1.0      -1.0      -0.974082840593171      -0.932309038992748      -0.847452388537183      -0.724680039139838      -0.584206488705884      -0.448368344074227      -0.33315293623822      -0.244180789845194      -0.177141946974804      -0.122686145196158      -0.0757668499037829      -0.0494391409323673      -1.0      -1.0      -1.0      -1.0      0.0      0.0      0.0      0.0      -1.0 ]    


P=(1/(lamda_old))*(P_old-(P_old*phi*pinv(lamda_old+phi'*P_old*phi)*phi'*P_old));
pP=pinv(P);
    
    function V=objective(Q)
        f=(Q-Q_old)'*pP*(Q-Q_old);
        f1=(Y-phi'*Q)'*(Y-phi'*Q);
        total=f+f1;
        V=(Q-Q_old)'*pP*(Q-Q_old)+(Y-phi'*Q)'*(Y-phi'*Q);
    end


    function [c, ceq]=constraint(Q)
           A=Q(1:3,1)';B1=Q(4:15,1)';B2=Q(16:19,1)';B3=Q(20:23,1)';C=Q(24,1)';
%          A=Q(1:3,1);B1=Q(4:15,1);B2=Q(16:19,1);B3=Q(20:23,1);C=Q(24,1);
        %% Converting to State Space
        A_state=[-A B1(2:end) B2(2:end) B3(2:end) C;...
            1 zeros(1,20);...
            zeros(1,1) 1 zeros(1,19);...
            zeros(1,21);...
            zeros(1,3) 1 zeros(1,17);...
            zeros(1,4) 1 zeros(1,16);...
            zeros(1,5) 1 zeros(1,15);...
            zeros(1,6) 1 zeros(1,14);...
            zeros(1,7) 1 zeros(1,13);...
            zeros(1,8) 1 zeros(1,12);...
            zeros(1,9) 1 zeros(1,11);...
            zeros(1,10) 1 zeros(1,10);...
            zeros(1,11) 1 zeros(1,9);...
            zeros(1,12) 1 zeros(1,8);...
            zeros(1,21);...
            zeros(1,14) 1 zeros(1,6);...
            zeros(1,15) 1 zeros(1,5);...
            zeros(1,21);...
            zeros(1,17) 1 zeros(1,3);...
            zeros(1,18) 1 zeros(1,2);...
            zeros(1,21)];
        eigA=abs(eig(A_state));
        c=max(eigA)-0.99;
        
            
        
        ceq = [];
    end
% options=optimset('Algorithm','active-set','Display','off');
 options=optimset('Algorithm','interior-point','Display','off');
 Q=fmincon(@objective,Q_old,[],[],[],[],lowerlim,upperlim,@constraint,options);
% Q=fmincon(@objective,Q_old,[],[],[],[],lowerlim,upperlim,[],options);
phi
Q
err=Y-phi'*Q
Y_model=phi'*Q
lamda1=0.9*lamda_old+(1-0.9)*0.99
lamda2=exp(-(err^2)/(1000))
lamda=lamda1*lamda2
if lamda<0.005;lamda=0.005;end
end