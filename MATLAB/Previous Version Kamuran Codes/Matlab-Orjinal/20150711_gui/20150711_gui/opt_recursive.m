function [Q Y_model P lamda err]=opt_recursive(Y,phi,Q_old,P_old,lamda_old,upperlim,lowerlim)

Y=165;

P_old=[5.115572062550341 -2.7254404447448435 -2.801018854993539 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -0.007314827182158146 0.0060562569807777475 0.006056256980586882 0.006056256980396017 0.004065553385401276 0.0052992248613775075 0.0052992248571148625 0.005299224856860378 -0.5038591389867281;
 -2.7254404449668166 226679.8711037596 -226667.33668694826 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 1391.3965734193544 490.09153878259315 490.09153878259315 490.09153878259315 511.98822325897856 428.83009643476646 428.8300964347688 428.83009643476896 33963.64671526273;
 -2.8010188550321913 -226667.3366869483 226675.90735053713 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -400.8910101791302 501.1152786643573 501.1152786643571 501.1152786643571 355.25304139629606 438.4758688313095 438.47586883131186 438.47586883131214 -33990.07189788077;
 0.0 0.0 0.0 458441.723732801 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0;
 0.0 0.0 0.0 0.0 458441.723732801 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0;
 0.0 0.0 0.0 0.0 0.0 458441.723732801 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0;
 0.0 0.0 0.0 0.0 0.0 0.0 458441.723732801 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0;
 0.0 0.0 0.0 0.0 0.0 0.0 0.0 458441.723732801 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0;
 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 458441.723732801 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0;
 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 458441.723732801 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0;
 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 458441.723732801 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0;
 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 458441.723732801 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0;
 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 458441.723732801 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0;
 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 458441.723732801 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0;
 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 458441.723732801 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0;
 -0.00731482719059226 1391.3965734193607 -400.8910101791255 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 458125.50488915504 0.8667913733603863 0.866791373360374 0.8667913733603523 -28.497188480953678 0.7584424516902359 0.7584424516902507 0.7584424516902601 -11948.656750396245;
 0.006056256985187581 490.0915387825901 501.1152786643538 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.8667913733602804 458440.6402403065 -1.0834924944094184 -1.0834924944094184 -0.7681146841000929 -0.9480559326082295 -0.9480559326082344 -0.9480559326082352 73.4920473467691;
 0.006056256984169638 490.09153878259076 501.11527866435443 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.8667913733602901 -1.0834924944094202 458440.6402403065 -1.0834924944094204 -0.7681146841000916 -0.9480559326082295 -0.9480559326082344 -0.9480559326082352 73.49204734676952;
 0.006056256978889046 490.0915387825934 501.1152786643569 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.8667913733602671 -1.083492494409424 -1.083492494409424 458440.6402403065 -0.7681146841001014 -0.9480559326082376 -0.9480559326082404 -0.9480559326082412 73.49204734676881;
 0.004065553380014033 511.9882232589817 355.2530413962987 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -28.497188480953717 -0.7681146841001011 -0.7681146841001014 -0.7681146841001019 458438.49323352316 -0.6721003485875948 -0.672100348587597 -0.6721003485875974 -1044.9075839871857;
 0.005299224856997124 428.830096434769 438.4758688313118 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.7584424516902264 -0.9480559326082463 -0.9480559326082457 -0.9480559326082451 -0.6721003485875929 458440.89418385987 -0.8295489410322164 -0.8295489410322173 64.30554142842246;
 0.005299224856488151 428.830096434769 438.4758688313117 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.7584424516902071 -0.948055932608246 -0.9480559326082453 -0.9480559326082448 -0.6721003485875944 -0.8295489410322114 458440.89418385987 -0.8295489410322152 64.30554142842172;
 0.005299224855470206 428.8300964347697 438.4758688313128 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.7584424516902428 -0.9480559326082465 -0.9480559326082459 -0.9480559326082451 -0.6721003485875934 -0.8295489410322137 -0.8295489410322168 458440.89418385987 64.30554142842308;
 -0.5038591395018904 33963.64671526306 -33990.07189788035 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -11948.656750396241 73.49204734677289 73.49204734677217 73.49204734677173 -1044.9075839871853 64.30554142842283 64.30554142842331 64.3055414284232 5414.170536649663]

phi=[-185.0;
 -198.0;
 -200.0;
 0.0;
 0.0;
 0.0;
 0.0;
 0.0;
 0.0;
 0.0;
 0.0;
 0.0;
 0.0;
 0.0;
 0.0;
 3.05375075340271;
 3.05375075340271;
 0.4;
 0.4;
 0.5948460102081299;
 0.5948460102081299;
 0.35;
 0.35;
 49.12254149257464]

Q_old=[ -0.5345481613457798;
 -0.9986969485407852;
 0.5133697737393166;
 -0.003018467997054225;
 -0.02265186829557908;
 -0.042865727455229825;
 -0.05687426187911198;
 -0.11038492639799542;
 -0.13707218118113282;
 -0.05789610149109681;
 -0.017761185346143425;
 -0.012903085001476999;
 -0.006067148807202642;
 -0.0024025827404157117;
 -1.5173511350738102E-4;
 -0.10164197305939005;
 -0.029877340917670102;
 -0.032971231027929475;
 -0.1419738409819733;
 0.14864443894135604;
 0.02380274766959205;
 0.0355532348679717;
 0.05041544536705751;
 -0.05514219102767647]

lamda_old=0.09919642941438729

upperlim=[1.0      1.0      1.0      0.0      0.0      0.0      0.0      0.0      0.0      0.0      0.0      0.0      0.0      0.0      0.0      0.0      0.0      0.0      0.0      1.0      1.0      1.0      1.0      1.0]

lowerlim=[-1.0      -1.0      -1.0      -0.974082840593171      -0.932309038992748      -0.847452388537183      -0.724680039139838      -0.584206488705884      -0.448368344074227      -0.33315293623822      -0.244180789845194      -0.177141946974804      -0.122686145196158      -0.0757668499037829      -0.0494391409323673      -1.0      -1.0      -1.0      -1.0      0.0      0.0      0.0      0.0      -1.0 ]    


P=(1/(lamda_old))*(P_old-(P_old*phi*pinv(lamda_old+phi'*P_old*phi)*phi'*P_old));
pP=pinv(P)


    function V=objective(Q)
  
        
        V=(Q-Q_old)'*pP*(Q-Q_old)+(Y-phi'*Q)'*(Y-phi'*Q);
% V=(Y-phi'*Q)'*(Y-phi'*Q);
%  V=(Q-Q_old)'*pP*(Q-Q_old)
    end
    function [c, ceq]=constraint(Q)
        A=Q(1:3,1)';B1=Q(4:15,1)';B2=Q(16:19,1)';B3=Q(20:23,1)';C=Q(24,1)';
        %% Converting to State Space
        A_state=[-A B1(2:end) B2(2:end) B3(2:end) C;...
            1 zeros(1,20);...
            zeros(1,1) 1 zeros(1,19);...
            zeros(1,21);...
            zeros(1,3) 1 zeros(1,17);...
            zeros(1,4) 1 zeros(1,16);...
            zeros(1,5) 1 zeros(1,15);...
            zeros(1,6) 1 zeros(1,14);...
            zeros(1,7) 1 zeros(1,13);...
            zeros(1,8) 1 zeros(1,12);...
            zeros(1,9) 1 zeros(1,11);...
            zeros(1,10) 1 zeros(1,10);...
            zeros(1,11) 1 zeros(1,9);...
            zeros(1,12) 1 zeros(1,8);...
            zeros(1,21);...
            zeros(1,14) 1 zeros(1,6);...
            zeros(1,15) 1 zeros(1,5);...
            zeros(1,21);...
            zeros(1,17) 1 zeros(1,3);...
            zeros(1,18) 1 zeros(1,2);...
            zeros(1,21)];
        eigA=abs(eig(A_state));
        c=max(eigA)-0.99
        ceq = [];
    end

options=optimset('Algorithm','interior-point','Display','off');
Q=fmincon(@objective,Q_old,[],[],[],[],lowerlim,upperlim,@constraint,options);
% Q=fmincon(@objective,Q_old,[],[],[],[],lowerlim,upperlim,[],options);
% Q=fmincon(@objective,Q_old,[],[],[],[],[],[],[],options);
size(Q_old)

err=Y-phi'*Q;
Y_model=phi'*Q;
lamda1=0.9*lamda_old+(1-0.9)*0.99;
lamda2=exp(-(err^2)/(1000));
lamda=lamda1*lamda2;
Q
if lamda<0.005;lamda=0.005;end
end